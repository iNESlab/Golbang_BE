# 🚫 라디오 기능 비활성화 - 안드로이드에서 사용하지 않음
# nginx-rtmp 미디어 서버 설정
# worker_processes auto;
# rtmp_auto_push on;

events {
    worker_connections 1024;
}

# 🚫 라디오 기능 비활성화 - 안드로이드에서 사용하지 않음
# RTMP 블록 - 스트리밍 인제스트
# rtmp {
    # server {
    #     listen 1935;
    #     chunk_size 4096;
    #     
    #     # 라이브 스트리밍 애플리케이션
    #     application live {
    #         live on;
    #         
    #         # 스트림 교체 및 재시작 허용
    #         drop_idle_publisher 5s;    # 5초 후 유휴 퍼블리셔 드롭
    #         play_restart on;           # 스트림 재시작 허용
    #         allow_play all;
    #         allow_publish all;
    #         
    #         # HLS 설정
    #         hls on;
    #         hls_path /var/hls;
    #         hls_fragment 2s;           # 2초 세그먼트
    #         hls_playlist_length 30s;   # 30초 플레이리스트 (15개 세그먼트)
    #         hls_continuous on;         # 연속 재생
    #         hls_cleanup on;           # 자동 정리
    #         hls_nested off;           # 플랫 디렉토리 구조
    #         
    #         # 녹화 비활성화
    #         record off;
    #     }
    # }
# }

# HTTP 블록 - HLS 서빙 및 API
http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;
    
    # 로그 설정
    access_log /var/log/nginx/access.log;
    error_log /var/log/nginx/error.log warn;
    
    # 성능 최적화
    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    keepalive_timeout 65;
    
    # gzip 압축
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_types text/plain application/json application/x-javascript text/xml application/xml;
    
    server {
        listen 80;
        server_name localhost;
        
        # CORS 헤더 (Safari 호환성)
        add_header Access-Control-Allow-Origin * always;
        add_header Access-Control-Allow-Methods 'GET, POST, OPTIONS' always;
        add_header Access-Control-Allow-Headers 'Range, Content-Type' always;
        
        # 🚫 라디오 기능 비활성화 - 안드로이드에서 사용하지 않음
        # HLS 스트림 서빙
        # location /hls {
        #     # HLS 파일 위치
        #     alias /var/hls;
        #     
        #     # HLS 전용 헤더
        #     add_header Cache-Control no-cache always;
        #     add_header Access-Control-Allow-Origin * always;
        #     
        #     # MIME 타입 설정
        #     location ~ \.m3u8$ {
        #         add_header Content-Type application/vnd.apple.mpegurl;
        #         expires -1;
        #     }
        #     
        #     location ~ \.ts$ {
        #         add_header Content-Type video/mp2t;
        #         expires 1h;
        #     }
        # }
        
        # RTMP 통계 (모니터링용)
        # location /stat {
        #     rtmp_stat all;
        #     rtmp_stat_stylesheet stat.xsl;
        #     add_header Access-Control-Allow-Origin * always;
        # }
        
        # location /stat.xsl {
        #     root /etc/nginx/html;
        # }
        
        # Django 애플리케이션 프록시
        location / {
            proxy_pass http://web:8000;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            # 타임아웃 설정 (499 오류 방지)
            proxy_connect_timeout 60s;
            proxy_send_timeout 60s;
            proxy_read_timeout 60s;
            
            # WebSocket 지원
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
        }
        
        # 정적 파일 서빙
        location /static/ {
            alias /app/static/;
            expires 1y;
            add_header Cache-Control "public, immutable";
        }
        
        location /media/ {
            alias /app/media/;
            expires 1y;
            add_header Cache-Control "public, immutable";
        }
    }
}
