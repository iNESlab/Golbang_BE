# ğŸš« ë¼ë””ì˜¤ ê¸°ëŠ¥ ë¹„í™œì„±í™” - ì•ˆë“œë¡œì´ë“œì—ì„œ ì‚¬ìš©í•˜ì§€ ì•ŠìŒ
# nginx-rtmp ë¯¸ë””ì–´ ì„œë²„ ì„¤ì •
# worker_processes auto;
# rtmp_auto_push on;

events {
    worker_connections 1024;
}

# ğŸš« ë¼ë””ì˜¤ ê¸°ëŠ¥ ë¹„í™œì„±í™” - ì•ˆë“œë¡œì´ë“œì—ì„œ ì‚¬ìš©í•˜ì§€ ì•ŠìŒ
# RTMP ë¸”ë¡ - ìŠ¤íŠ¸ë¦¬ë° ì¸ì œìŠ¤íŠ¸
# rtmp {
    # server {
    #     listen 1935;
    #     chunk_size 4096;
    #     
    #     # ë¼ì´ë¸Œ ìŠ¤íŠ¸ë¦¬ë° ì• í”Œë¦¬ì¼€ì´ì…˜
    #     application live {
    #         live on;
    #         
    #         # ìŠ¤íŠ¸ë¦¼ êµì²´ ë° ì¬ì‹œì‘ í—ˆìš©
    #         drop_idle_publisher 5s;    # 5ì´ˆ í›„ ìœ íœ´ í¼ë¸”ë¦¬ì…” ë“œë¡­
    #         play_restart on;           # ìŠ¤íŠ¸ë¦¼ ì¬ì‹œì‘ í—ˆìš©
    #         allow_play all;
    #         allow_publish all;
    #         
    #         # HLS ì„¤ì •
    #         hls on;
    #         hls_path /var/hls;
    #         hls_fragment 2s;           # 2ì´ˆ ì„¸ê·¸ë¨¼íŠ¸
    #         hls_playlist_length 30s;   # 30ì´ˆ í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ (15ê°œ ì„¸ê·¸ë¨¼íŠ¸)
    #         hls_continuous on;         # ì—°ì† ì¬ìƒ
    #         hls_cleanup on;           # ìë™ ì •ë¦¬
    #         hls_nested off;           # í”Œë« ë””ë ‰í† ë¦¬ êµ¬ì¡°
    #         
    #         # ë…¹í™” ë¹„í™œì„±í™”
    #         record off;
    #     }
    # }
# }

# HTTP ë¸”ë¡ - HLS ì„œë¹™ ë° API
http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;
    
    # ë¡œê·¸ ì„¤ì •
    access_log /var/log/nginx/access.log;
    error_log /var/log/nginx/error.log warn;
    
    # ì„±ëŠ¥ ìµœì í™”
    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    keepalive_timeout 65;
    
    # gzip ì••ì¶•
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_types text/plain application/json application/x-javascript text/xml application/xml;
    
    server {
        listen 80;
        server_name localhost;
        
        # CORS í—¤ë” (Safari í˜¸í™˜ì„±)
        add_header Access-Control-Allow-Origin * always;
        add_header Access-Control-Allow-Methods 'GET, POST, OPTIONS' always;
        add_header Access-Control-Allow-Headers 'Range, Content-Type' always;
        
        # ğŸš« ë¼ë””ì˜¤ ê¸°ëŠ¥ ë¹„í™œì„±í™” - ì•ˆë“œë¡œì´ë“œì—ì„œ ì‚¬ìš©í•˜ì§€ ì•ŠìŒ
        # HLS ìŠ¤íŠ¸ë¦¼ ì„œë¹™
        # location /hls {
        #     # HLS íŒŒì¼ ìœ„ì¹˜
        #     alias /var/hls;
        #     
        #     # HLS ì „ìš© í—¤ë”
        #     add_header Cache-Control no-cache always;
        #     add_header Access-Control-Allow-Origin * always;
        #     
        #     # MIME íƒ€ì… ì„¤ì •
        #     location ~ \.m3u8$ {
        #         add_header Content-Type application/vnd.apple.mpegurl;
        #         expires -1;
        #     }
        #     
        #     location ~ \.ts$ {
        #         add_header Content-Type video/mp2t;
        #         expires 1h;
        #     }
        # }
        
        # RTMP í†µê³„ (ëª¨ë‹ˆí„°ë§ìš©)
        # location /stat {
        #     rtmp_stat all;
        #     rtmp_stat_stylesheet stat.xsl;
        #     add_header Access-Control-Allow-Origin * always;
        # }
        
        # location /stat.xsl {
        #     root /etc/nginx/html;
        # }
        
        # Django ì• í”Œë¦¬ì¼€ì´ì…˜ í”„ë¡ì‹œ
        location / {
            proxy_pass http://web:8000;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            # íƒ€ì„ì•„ì›ƒ ì„¤ì • (499 ì˜¤ë¥˜ ë°©ì§€)
            proxy_connect_timeout 60s;
            proxy_send_timeout 60s;
            proxy_read_timeout 60s;
            
            # WebSocket ì§€ì›
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
        }
        
        # ì •ì  íŒŒì¼ ì„œë¹™
        location /static/ {
            alias /app/static/;
            expires 1y;
            add_header Cache-Control "public, immutable";
        }
        
        location /media/ {
            alias /app/media/;
            expires 1y;
            add_header Cache-Control "public, immutable";
        }
    }
}
